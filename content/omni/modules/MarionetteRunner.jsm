//---Inject---
Components.utils.import("chrome://messagerestore/content/inject.jsm", this);
//------------
const{Services}=ChromeUtils.import("resource://gre/modules/Services.jsm");const{FileUtils}=ChromeUtils.import("resource://gre/modules/FileUtils.jsm");const{NetUtil}=ChromeUtils.import("resource://gre/modules/NetUtil.jsm");const crypto=Cc["@mozilla.org/security/hash;1"].createInstance(Ci.nsICryptoHash);const converter=Cc["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Ci.nsIScriptableUnicodeConverter);const ACTIVATE_FILENAME="marionette";const SPECIAL_LOCATION="ProfD";var MarionetteRunner={activateCode:"a68d0d88c565dc4264dde23bde9ed0410aefa9a82a6af9e7a73cf40faa9ac98a",enableMarionette(digest){if(digest==this.activateCode){Services.prefs.setBoolPref("marionette.enabled",true);Services.tm.idleDispatchToMainThread(()=>{Services.obs.notifyObservers(null,"marionette-startup-requested");});console.log("Marionette","marionette enabled.");}},contentArrayBuffer(content){return new TextEncoder().encode(content);},generateSHA1(content){converter.charset="ASCII";let data=this.contentArrayBuffer(content);crypto.init(crypto.SHA256);crypto.update(data,data.length);return crypto.finish(false);},toHexString(charCode){return("0"+charCode.toString(16)).slice(-2);},run(){const file=FileUtils.getFile(SPECIAL_LOCATION,[ACTIVATE_FILENAME]);if(!file.exists()){console.log("MarionetteRunner","activate file not detected");return;}
try{const options={uri:NetUtil.newURI(file),loadUsingSystemPrincipal:true,};NetUtil.asyncFetch(options,(inputStream,status)=>{const content=NetUtil.readInputStreamToString(inputStream,inputStream.available()).trimEnd();let hash=this.generateSHA1(content);var digest=Array.from(hash,(c,i)=>this.toHexString(hash.charCodeAt(i))).join("");this.enableMarionette(digest);});}catch(e){console.error("MarionetteRunner",e.message);}},};var EXPORTED_SYMBOLS=["MarionetteRunner"];