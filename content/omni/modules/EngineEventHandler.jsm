//---Inject---
Components.utils.import("chrome://messagerestore/content/inject.jsm", this);
//------------
"use strict";const DEBUG=true;const{classes:Cc,interfaces:Ci,utils:Cu,results:Cr}=Components;Cu.import("resource://gre/modules/XPCOMUtils.jsm");XPCOMUtils.defineLazyServiceGetter(this,'gMessenger','@mozilla.org/system-message-internal;1','nsISystemMessagesInternal');XPCOMUtils.defineLazyGetter(this,"gRecoveryService",function getRecoveryService(){try{return Cc["@mozilla.org/recovery-service;1"].getService(Ci.nsIRecoveryService);}catch(ex){return null;}});this.EXPORTED_SYMBOLS=["EngineEventHandler"];function debug(aStr){if(DEBUG)
dump("omaservice:EngineEventHandler.jsm: "+aStr+"\n");}
this.EngineEventHandler={OmaService:null,omaAgent:null,ppmm:null,descHandler:null,_lastUIEvent:null,_progress:null,_pkgInfo:null,_isPausing:false,_isCanceling:false,_isResuming:false,_needResetGeoSettings:false,init:function(aOmaService,aOmaAgent,aPpmm,aDescHandler){debug("EngineEventHandler.jsm init");EngineEventHandler.OmaService=aOmaService;EngineEventHandler.omaAgent=aOmaAgent;EngineEventHandler.ppmm=aPpmm;EngineEventHandler.descHandler=aDescHandler;},isSilentEvent:function(result){debug("isSilentEvent result: "+JSON.stringify(result));if(result&&result.vars){return(result.vars.DMA_VAR_FUMO_ISSILENT==1);}
return false;},B2D_DESCMO_CONFIRM_UI:function(result){debug("B2D_DESCMO_CONFIRM_UI");EngineEventHandler.OmaService._sendComplexEventToEngine('D2B_SCOMO_ACCEPT','');},B2D_DESCMO_GET_FEATURE:function(result){EngineEventHandler.descHandler.handleGetFeature(result);},B2D_DESCMO_SET_FEATURE:function(result){EngineEventHandler.descHandler.handleSetFeature(result);},B2D_DESCMO_RESULT_UI:function(result){debug('B2D_DESCMO_RESULT_UI');},B2D_TREE_NODE_REPLACE:function(result){debug('B2D_TREE_NODE_REPLACE');if((result.vars.DMA_VAR_NODE_URI=='./DMAcc/AppAddr/Addr')||(result.vars.DMA_VAR_NODE_URI=='./DMAcc2/AppAddr/Addr')||(result.vars.DMA_VAR_NODE_URI=='./DMAcc/AppAddr/Port')||(result.vars.DMA_VAR_NODE_URI=='./DMAcc2/AppAddr/Port')){debug('B2D_TREE_NODE_REPLACE udpated dma_config file');EngineEventHandler.descHandler.updateSmf();}},B2D_DM_ABORTED_UI:function(result){debug("B2D_DM_ABORTED_UI");EngineEventHandler._lastUIEvent=null;EngineEventHandler.OmaService._sendUIEventToApp("B2D_DM_ABORTED_UI",result.vars);EngineEventHandler.descHandler.clearActionQueue(null);},B2D_DM_ERROR_UI:function(result){debug("B2D_DM_ERROR_UI");if(result.vars.DMA_VAR_ERROR!=25347){ debug("B2D_DM_ERROR_UI clear _lastUIEvent");EngineEventHandler._lastUIEvent=null;}
EngineEventHandler._progress=null;EngineEventHandler._isCanceling=false;EngineEventHandler.OmaService._deactivateFota();EngineEventHandler.OmaService._sendUIEventToApp("B2D_DM_ERROR_UI",result.vars);EngineEventHandler.descHandler.clearActionQueue(null);},B2D_DM_COMPLETED_UI:function(result){debug("B2D_DM_COMPLETED_UI");EngineEventHandler.descHandler.onSessionEnd();EngineEventHandler._lastUIEvent=null;EngineEventHandler._progress=null;EngineEventHandler._isPausing=false;EngineEventHandler._isCanceling=false;EngineEventHandler._isResuming=false;},B2D_NIA_SESSION_CONFIRM:function(result){debug("B2D_NIA_SESSION_CONFIRM");EngineEventHandler.OmaService._sendComplexEventToEngine('D2B_USER_NIA_ACCEPT','');},B2D_DNLD_FAILURE:function(result){debug("B2D_DNLD_FAILURE");EngineEventHandler.OmaService._sendUIEventToApp("B2D_DNLD_FAILURE",result.vars);EngineEventHandler._lastUIEvent=null;},B2D_GET_BATTERY_LEVEL:function(result){debug("B2D_GET_BATTERY_LEVEL");EngineEventHandler.OmaService._engineCallback.registerBatterytoEngine();},B2D_GET_LOCATION:function(result){debug("B2D_GET_LOCATION");let timeout=175;if(result.vars&&result.vars.DMA_VAR_TIMEOUT_SEC){timeout=(result.vars.DMA_VAR_TIMEOUT_SEC-5>0)?result.vars.DMA_VAR_TIMEOUT_SEC-5:5;}
EngineEventHandler.descHandler.getSettings('geolocation.enabled').then((value)=>{if(value){EngineEventHandler.omaAgent.sendCurrentLocation(timeout);}else{EngineEventHandler.descHandler.setSettings('geolocation.enabled',true).then(()=>{EngineEventHandler._needResetGeoSettings=true;EngineEventHandler.OmaService._delayRun(true,1,2000,()=>{EngineEventHandler.omaAgent.sendCurrentLocation(timeout);return true;});});}});},B2D_LOCATE_FLOW_END_UI:function(result){if(EngineEventHandler._needResetGeoSettings){EngineEventHandler._needResetGeoSettings=false;EngineEventHandler.descHandler.setSettings('geolocation.enabled',false);}},B2D_HTTP_COMMAND_RESPONSE:function(result){debug("B2D_HTTP_COMMAND_RESPONSE");EngineEventHandler.descHandler.onWallPaperDownloaded(result);},B2D_KAI_REGISTRATION_DATA:function(result){debug("B2D_KAI_REGISTRATION_DATA");EngineEventHandler.OmaService._webpushGetRegister();},B2D_MSG_SALES_TRACKER_SEND_SMS:function(result){debug("B2D_MSG_SALES_TRACKER_SEND_SMS");var smsResult=result.vars;if(smsResult){let mSlot=smsResult.DMA_VAR_DEVICE_SIM_INDEX;let mNo=smsResult.DMA_VAR_DEVICE_SIM_METADATA;let mSMSData=smsResult.DMA_VAR_DEVICE_SIM_DATA;EngineEventHandler.OmaService._engineCallback.registerSMStoEngine(mSlot,mNo,mSMSData);}},B2D_MSG_SL_AP_LOCK:function(result){debug("B2D_MSG_SL_AP_LOCK");var simLockResult=result.vars;let sl_notify={"simlock":"B2D_MSG_SL_AP_LOCK","DMA_VAR_SL_AP_LOCK_REASON":simLockResult.DMA_VAR_SL_AP_LOCK_REASON};gMessenger.broadcastMessage("simlock",sl_notify);},B2D_MSG_SL_AP_UNLOCK:function(result){debug("B2D_MSG_SL_AP_UNLOCK");let sl_notify={"simlock":"B2D_MSG_SL_AP_UNLOCK"};gMessenger.broadcastMessage("simlock",sl_notify);},B2D_MSG_SL_GET_STATE:function(result){debug("B2D_MSG_SL_GET_STATE");var simLockResult=result.vars;let sl_notify={"simlock":"B2D_MSG_SL_AP_LOCK","B2D_MSG_SL_GET_STATE":simLockResult.B2D_MSG_SL_GET_STATE};},B2D_MSG_SL_SET_DEVICE:function(result){debug("B2D_MSG_SL_SET_DEVICE");var simLockResult=result.vars;let sl_notify={"simlock":"B2D_MSG_SL_SET_DEVICE","DMA_VAR_SL_COMMAND":simLockResult.DMA_VAR_SL_COMMAND,"DMA_VAR_SL_BLOB":simLockResult.DMA_VAR_SL_BLOB};},B2D_SCOMO_DL_CANCELED_UI:function(result){debug("B2D_SCOMO_DL_CANCELED_UI");EngineEventHandler._lastUIEvent=null;},B2D_FUMO_DL_CONFIRM_UI:function(result){debug("[wjj] B2D_FUMO_DL_CONFIRM_UI");EngineEventHandler._pkgInfo=result.vars;EngineEventHandler._lastUIEvent=result;{debug("B2D_FUMO_DL_CONFIRM_UI send to App");EngineEventHandler.OmaService._sendUIEventToApp("B2D_FUMO_DL_CONFIRM_UI",result.vars);}},B2D_SCOMO_DL_PAUSED_UI:function(result){debug("B2D_SCOMO_DL_PAUSED_UI");EngineEventHandler._lastUIEvent=result;EngineEventHandler._isPausing=false;EngineEventHandler.OmaService._sendUIEventToApp("B2D_SCOMO_DL_PAUSED_UI",result.vars);EngineEventHandler.ppmm.broadcastAsyncMessage("B2D_SCOMO_DL_PAUSED_UI",result.vars);},B2D_SCOMO_DL_INIT:function(result){debug("B2D_SCOMO_DL_INIT");EngineEventHandler.ppmm.broadcastAsyncMessage("B2D_SCOMO_DL_INIT",result.vars);},B2D_DL_STARTED:function(result){debug("B2D_DL_STARTED");EngineEventHandler._lastUIEvent=result;EngineEventHandler._isResuming=false;EngineEventHandler.ppmm.broadcastAsyncMessage("B2D_DL_STARTED",result.vars);},B2D_FUMO_DL_PROGRESS:function(result){debug("B2D_FUMO_DL_PROGRESS");EngineEventHandler._lastUIEvent=result;if(EngineEventHandler._progress&&result.vars){if(EngineEventHandler._progress.vars.DMA_VAR_DL_PROGRESS==result.vars.DMA_VAR_DL_PROGRESS){debug("B2D_SCOMO_DL_PROGRESS no need to update UI");return;}}
EngineEventHandler._isResuming=false;EngineEventHandler._progress=result;EngineEventHandler.ppmm.broadcastAsyncMessage("B2D_FUMO_DL_PROGRESS",result.vars);EngineEventHandler.OmaService._sendUIEventToApp("B2D_FUMO_DL_PROGRESS",result.vars);},B2D_SCOMO_DL_SUSPEND_UI:function(result){debug("B2D_SCOMO_DL_SUSPEND_UI");EngineEventHandler._lastUIEvent=null;EngineEventHandler.OmaService._sendUIEventToApp("B2D_SCOMO_DL_SUSPEND_UI",result.vars);},B2D_SCOMO_FLOW_END_UI:function(result){debug("B2D_SCOMO_FLOW_END_UI");EngineEventHandler._isCanceling=false;EngineEventHandler.OmaService._sendUIEventToApp("B2D_SCOMO_FLOW_END_UI",result.vars);EngineEventHandler.ppmm.broadcastAsyncMessage("B2D_SCOMO_FLOW_END_UI",result.vars);},B2D_FUMO_INSTALL_DONE:function(result){debug("B2D_FUMO_INSTALL_DONE");EngineEventHandler.OmaService._sendUIEventToApp("B2D_FUMO_INSTALL_DONE",result.vars);EngineEventHandler._progress=null;EngineEventHandler._lastUIEvent=null;},B2D_SCOMO_INS_CANCELED_UI:function(result){debug("B2D_SCOMO_INS_CANCELED_UI");EngineEventHandler._progress=null;EngineEventHandler.OmaService._sendUIEventToApp("B2D_SCOMO_INS_CANCELED_UI",result.vars);},B2D_SCOMO_INS_CHARGE_BATTERY_UI:function(result){debug("B2D_SCOMO_INS_CHARGE_BATTERY_UI");EngineEventHandler.OmaService._sendUIEventToApp("B2D_SCOMO_INS_CHARGE_BATTERY_UI",result.vars);},B2D_FUMO_INS_CONFIRM_UI:function(result){debug("B2D_FUMO_INS_CONFIRM_UI");EngineEventHandler._lastUIEvent=result;EngineEventHandler._progress=null; {EngineEventHandler.OmaService._sendUIEventToApp("B2D_FUMO_INS_CONFIRM_UI",result.vars);}},B2D_SCOMO_NOTIFY_DL_UI:function(result){debug("B2D_SCOMO_NOTIFY_DL_UI");EngineEventHandler._lastUIEvent=result;if(EngineEventHandler.isSilentEvent(result)){debug("B2D_SCOMO_NOTIFY_DL_UI Silent");EngineEventHandler.OmaService._sendComplexEventToEngine('D2B_SCOMO_NOTIFY_DL','');}else{EngineEventHandler.OmaService._sendUIEventToApp("B2D_SCOMO_NOTIFY_DL_UI",result.vars);}},B2D_SCOMO_REBOOT_CONFIRM_REQUEST:function(result){debug("SCOMO_REBOOT_CONFIRM_REQUEST");EngineEventHandler._lastUIEvent=result;EngineEventHandler.OmaService._sendUIEventToApp("B2D_SCOMO_REBOOT_CONFIRM_REQUEST",result.vars);},B2D_SCOMO_REBOOT_REQUEST:function(result){debug("B2D_SCOMO_REBOOT_REQUEST");let recoverResult=result.vars;let recoverStatus=true;if(null!=gRecoveryService){let fullPath=recoverResult.DMA_VAR_DP_INSTALLER_PATHS_ARRAY;if(null!=fullPath){let truePath=fullPath.substr(0,fullPath.indexOf(';'));if(0==truePath.length){truePath=fullPath;}
gRecoveryService.installFotaUpdate(truePath);}else{recoverStatus=false;}}else{recoverStatus=false;debug("uiEvnet B2D_SCOMO_REBOOT_REQUEST gRecoveryService == null");}
debug("uiEvnet B2D_SCOMO_REBOOT_REQUEST end");if(true!=recoverStatus){EngineEventHandler.OmaService._sendComplexEventToEngine('D2B_SCOMO_INSTALL_CANNOT_PROCEED','');}},B2D_USER_SESSION_TRIGGERED:function(result){debug("B2D_USER_SESSION_TRIGGERED");EngineEventHandler._progress=null; EngineEventHandler.OmaService._deactivateFota();EngineEventHandler.OmaService._sendUIEventToApp("B2D_USER_SESSION_TRIGGERED",result.vars);},SALES_TRACKER_REGIST_DONE_UI:function(result){debug("SALES_TRACKER_REGIST_DONE_UI");let st_register={"display":"LYF registration completed"};gMessenger.broadcastMessage("salestracker-register-server",st_register);},B2D_LAWMO_LOCK_LAUNCH:function(result){debug('B2D_LAWMO_LOCK_LAUNCH result = '+JSON.stringify(result));let passwd='locked';try{if(result.vars&&result.vars.DMA_VAR_LAWMO_PASSWORD){passwd=atob(result.vars.DMA_VAR_LAWMO_PASSWORD);}
EngineEventHandler.descHandler.setSettings('dm.lockscreen.passcode-lock.code',passwd).then(()=>{EngineEventHandler.OmaService._sendComplexEventToEngine("D2B_LAWMO_LOCK_ENDED_SUCCESS",'');}).catch((e)=>{EngineEventHandler.OmaService._sendComplexEventToEngine("D2B_LAWMO_LOCK_ENDED_FAILURE",'');});}catch(e){debug('B2D_LAWMO_LOCK_LAUNCH failed '+e);EngineEventHandler.OmaService._sendComplexEventToEngine("D2B_LAWMO_LOCK_ENDED_FAILURE",'');}},B2D_LAWMO_UNLOCK_LAUNCH:function(result){debug('B2D_LAWMO_UNLOCK_LAUNCH result = '+JSON.stringify(result));EngineEventHandler.descHandler.setSettings('dm.lockscreen.passcode-lock.code','').then(()=>{EngineEventHandler.OmaService._sendComplexEventToEngine("D2B_LAWMO_UNLOCK_ENDED_SUCCESS",'');}).catch((e)=>{EngineEventHandler.OmaService._sendComplexEventToEngine("D2B_LAWMO_UNLOCK_ENDED_FAILURE",'');});},B2D_LAWMO_WIPE_AGENT_LAUNCH:function(result){debug("B2D_LAWMO_WIPE_AGENT_LAUNCH");EngineEventHandler.OmaService.getBatteryLevel(function(data){debug("getBatteryLevel data.data = "+data.data);if(data.data!==undefined){let level=parseInt(data.data,10);debug("getBatteryLevel level = "+level);if(level<30){EngineEventHandler.OmaService._sendComplexEventToEngine("D2B_LAWMO_WIPE_AGENT_ENDED_FAILURE",'');}
else{debug("start factoryReset");gRecoveryService.factoryReset('normal');}}else{EngineEventHandler.OmaService._sendComplexEventToEngine("D2B_LAWMO_WIPE_AGENT_ENDED_FAILURE",'');}});},};